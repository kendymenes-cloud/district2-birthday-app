<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>District 2 Birthday App (v2.4)</title>
    <style>
        :root {
            --primary-color: #0d47a1; /* Darker Blue */
            --secondary-color: #1976d2; /* Lighter Blue */
            --light-gray: #f5f5f5;
            --gray: #e0e0e0;
            --dark-gray: #424242;
            --white: #ffffff;
            --red: #d32f2f;
            --green: #388e3c;
            --yellow: #fbc02d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            font-family: var(--font);
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            color: var(--dark-gray);
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
            color: var(--primary-color);
        }
        .add-btn {
            background: var(--green);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-btn:hover { background: #2e7d32; }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 25px;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
        }
        .card-value-small {
            font-size: 1.5rem;
            color: var(--dark-gray);
        }

        /* Main App Body */
        .app-body {
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        nav {
            display: flex;
            gap: 15px;
            padding: 20px 30px;
            border-bottom: 2px solid var(--gray);
        }
        .nav-btn {
            background: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--gray);
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .nav-btn:hover { background-color: #e2e6ea; }
        .nav-btn.active {
            background-color: var(--secondary-color);
            color: var(--white);
            border-color: var(--secondary-color);
        }
        
        main { padding: 30px; }
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .filter-group select, .filter-group input[type="text"] {
            padding: 12px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--white);
        }
        .filter-group input[type="text"] { padding-right: 35px; } /* Space for spinner */
        
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 25px; /* Align with inputs */
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--secondary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .table-container {
            overflow-x: auto;
            max-height: 60vh;
            border: 1px solid var(--gray);
            border-radius: 8px;
            position: relative;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
            white-space: nowrap;
        }
        th {
            background: #f9f9f9;
            font-weight: 600;
            cursor: pointer;
        }
        th:hover { background: #f0f0f0; }
        tr:nth-child(even) { background-color: var(--light-gray); }
        tr:hover { background-color: #e9ecef; }
        
        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--white);
        }
        .priority-badge.p-1 { background-color: var(--red); }
        .priority-badge.p-2 { background-color: var(--yellow); color: #333; }
        .priority-badge.p-3 { background-color: var(--secondary-color); }

        .action-btn {
            background: var(--secondary-color);
            color: var(--white);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-right: 5px;
        }
        .action-btn:hover { background: var(--primary-color); }
        .action-btn.copy-btn { background: var(--yellow); color: #333; }
        .action-btn.copy-btn:hover { background: #ffc107b3; }
        .action-btn.logged { background: var(--gray); cursor: not-allowed; }
        .action-btn.template-btn { background: var(--green); }
        .action-btn.template-btn:hover { background: #2e7d32; }

        .loader-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        .loader-spinner {
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #result-count {
            margin-top: 15px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Modals (Shared Styles) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .modal-header h2 { margin: 0; }
        .close-btn {
            color: var(--dark-gray);
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close-btn:hover { color: #000; }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        .form-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            border: none;
        }
        .form-btn.submit {
            background-color: var(--green);
            color: var(--white);
        }
        .form-btn.cancel {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--gray);
        }
        .status-message {
            text-align: center;
            font-weight: 600;
            display: none;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .status-message.success { background-color: #d4edda; color: #155724; }
        .status-message.error { background-color: #f8d7da; color: #721c24; }

        /* Add Person Modal */
        #add-person-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Greeting Template Modal */
        #template-modal-name {
            color: var(--primary-color);
            font-weight: 700;
        }
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .template {
            border: 1px solid var(--gray);
            border-radius: 8px;
        }
        .template-body {
            padding: 15px;
            background: var(--light-gray);
            font-size: 0.95rem;
        }
        .template-actions {
            padding: 10px 15px;
            border-top: 1px solid var(--gray);
            display: flex;
            justify-content: flex-end;
        }
        .template-copy-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .template-copy-btn:hover { background: var(--primary-color); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>District 2 Birthday App</h1>
            <button class="add-btn" id="open-add-modal-btn">Add New Official</button>
        </header>

        <div class="dashboard-cards">
            <div class="card">
                <div class="card-title">Today's Birthdays</div>
                <div class="card-value" id="card-today">-</div>
            </div>
            <div class="card">
                <div class="card-title">Upcoming (Next 7 Days)</div>
                <div class="card-value" id="card-upcoming">-</div>
            </div>
            <div class="card">
                <div class="card-title">Greetings Logged Today</div>
                <div class="card-value" id="card-logged">-</div>
            </div>
            <div class="card">
                <div class="card-title">Total Officials in DB</div>
                <div class="card-value" id="card-total">-</div>
            </div>
        </div>

        <div class="app-body">
            <nav>
                <button class="nav-btn active" data-filter="today">Today's Birthdays</button>
                <button class="nav-btn" data-filter="upcoming7">Upcoming 7 Days</button>
                <button class="nav-btn" data-filter="all">All Birthdays</button>
            </nav>

            <main>
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="search-name">Search by Name</label>
                        <input type="text" id="search-name" placeholder="Enter name...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-month">Filter by Month</label>
                        <select id="filter-month">
                            <option value="">All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-municipality">Filter by Municipality</label>
                        <select id="filter-municipality">
                            <option value="">All Municipalities</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-position">Filter by Position</label>
                        <select id="filter-position">
                            <option value="">All Positions</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-barangay">Filter by Barangay</label>
                        <select id="filter-barangay">
                            <option value="">All Barangays</option>
                        </select>
                    </div>
                    <div class="filter-group toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-needs-greeting">
                            <span class="slider"></span>
                        </label>
                        <label for="toggle-needs-greeting" style="margin-bottom: 0;">Show un-logged only</label>
                    </div>
                </div>

                <div id="result-count">Loading...</div>

                <div class="table-container">
                    <table id="birthday-table">
                        <thead>
                            <tr>
                                <th data-sort="priority">Priority</th>
                                <th data-sort="birthday">Birthday</th>
                                <th data-sort="name">Full Name</th>
                                <th data-sort="position">Position</th>
                                <th data-sort="barangay">Barangay</th>
                                <th data-sort="municipality">Municipality</th>
                                <th data-sort="contact">Contact No.</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                    <div class="loader-overlay" id="table-loader">
                        <div class="loader-spinner"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="add-person-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Official</h2>
                <span class="close-btn" id="close-add-modal-btn">&times;</span>
            </div>
            <form id="add-person-form">
                <div class="form-group full-width">
                    <label for="form-fullName">Full Name</label>
                    <input type="text" id="form-fullName" required>
                </div>
                <div class="form-group">
                    <label for="form-birthday">Birthday</label>
                    <input type="date" id="form-birthday" required>
                </div>
                <div class="form-group">
                    <label for="form-contactNo">Contact No.</label>
                    <input type="text" id="form-contactNo">
                </div>
                <div class="form-group">
                    <label for="form-position">Position</label>
                    <input type="text" id="form-position">
                </div>
                <div class="form-group">
                    <label for="form-barangay">Barangay</label>
                    <input type="text" id="form-barangay">
                </div>
                <div class="form-group full-width">
                    <label for="form-municipality">Municipality</label>
                    <select id="form-municipality">
                        <option value="">Select Municipality</option>
                        </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="form-btn cancel" id="cancel-form-btn">Cancel</button>
                    <button type="submit" class="form-btn submit">Add Official</button>
                </div>
                <div id="form-status" class="status-message full-width"></div>
            </form>
        </div>
    </div>

    <div id="template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Greeting Templates for <span id="template-modal-name"></span></h2>
                <span class="close-btn" id="close-template-modal-btn">&times;</span>
            </div>
            <div class="template-list" id="template-list-body">
                </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQB8KHS-SrFpga692Q_wwudapwPlDEZWdqzkF4cIKU1-fSxdbI8InNkFg5ivyloLCk/exec';
        
        // --- GLOBAL VARIABLES ---
        let currentSort = { column: 'priority', asc: true };
        let activeDateFilter = 'today';
        let currentDataCache = []; // Caches the last data fetch
        let municipalityOptions = [];
        let positionOptions = [];
        let barangayOptions = [];
        
        // --- DOM ELEMENTS ---
        const tableBody = document.getElementById('table-body');
        const resultCount = document.getElementById('result-count');
        const tableLoader = document.getElementById('table-loader');
        
        // Cards
        const cardToday = document.getElementById('card-today');
        const cardUpcoming = document.getElementById('card-upcoming');
        const cardLogged = document.getElementById('card-logged');
        const cardTotal = document.getElementById('card-total');
        
        // Filters
        const navButtons = document.querySelectorAll('.nav-btn');
        const searchInput = document.getElementById('search-name');
        const monthFilter = document.getElementById('filter-month');
        const municipalityFilter = document.getElementById('filter-municipality');
        const positionFilter = document.getElementById('filter-position');
        const barangayFilter = document.getElementById('filter-barangay');
        const needsGreetingToggle = document.getElementById('toggle-needs-greeting');
        
        // Add Person Modal
        const addModal = document.getElementById('add-person-modal');
        const openAddModalBtn = document.getElementById('open-add-modal-btn');
        const closeAddModalBtn = document.getElementById('close-add-modal-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const addPersonForm = document.getElementById('add-person-form');
        const formStatus = document.getElementById('form-status');
        const formMunicipalitySelect = document.getElementById('form-municipality');

        // Template Modal
        const templateModal = document.getElementById('template-modal');
        const templateModalName = document.getElementById('template-modal-name');
        const templateListBody = document.getElementById('template-list-body');
        const closeTemplateModalBtn = document.getElementById('close-template-modal-btn');


        // --- API CALLS (to Google Apps Script) ---

        /**
         * Fetches data from the Apps Script backend using POST.
         * @param {string} action - The 'action' to perform (e.g., 'getDashboardData').
         * @param {object} payload - The data payload for the action.
         */
        async function fetchFromScript(action, payload = {}) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    redirect: 'follow',
                    body: JSON.stringify({ action: action, payload: payload }),
                });

                if (!response.ok) {
                    throw new Error(`Network error: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(`Script error: ${result.message}`);
                }
                return result;
            } catch (error) {
                console.error(`Error during fetch action '${action}':`, error);
                alert(`Error: ${error.message}. Please check console.`);
                return null;
            }
        }
        
        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            // Run dashboard and filter loading in parallel
            await Promise.all([
                loadDashboardData(),
                loadFilterOptions()
            ]);
            
            // Now load the initial table view
            await loadFilteredData();

            // Set up all event listeners
            setupEventListeners();
        }

        async function loadDashboardData() {
            const result = await fetchFromScript('getDashboardData');
            if (result) {
                cardToday.textContent = result.todaysBirthdays;
                cardUpcoming.textContent = result.upcomingWeek;
                cardLogged.textContent = `${result.loggedToday} / ${result.todaysBirthdays}`;
                cardTotal.textContent = result.totalOfficials;
                
                // Set today's date in the card title
                const today = new Date();
                const cardTitle = document.querySelector('.card:first-child .card-title');
                cardTitle.textContent = `Today's Birthdays (${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            }
        }

        async function loadFilterOptions() {
            const result = await fetchFromScript('getFilterOptions');
            if (result) {
                municipalityOptions = result.municipalities;
                positionOptions = result.positions;
                barangayOptions = result.barangays;
                
                populateSelect(municipalityFilter, municipalityOptions, "All Municipalities");
                populateSelect(positionFilter, positionOptions, "All Positions");
                populateSelect(barangayFilter, barangayOptions, "All Barangays");
                
                // Also populate the modal dropdown
                populateSelect(formMunicipalitySelect, municipalityOptions, "Select Municipality");
            }
        }
        
        /**
         * The main data loading function for the table.
         * Gathers all filter values and calls the backend.
         */
        async function loadFilteredData() {
            tableLoader.style.display = 'flex';
            resultCount.textContent = 'Loading...';
            
            const payload = {
                dateFilter: activeDateFilter,
                search: searchInput.value,
                month: monthFilter.value,
                municipality: municipalityFilter.value,
                position: positionFilter.value,
                barangay: barangayFilter.value,
            };

            const result = await fetchFromScript('getFilteredData', payload);

            if (result && result.data) {
                // Parse dates which come as strings
                result.data.forEach(p => {
                    p.birthday = new Date(p.birthday);
                    p.month = p.birthday.getMonth() + 1;
                    p.day = p.birthday.getDate();
                });
                currentDataCache = result.data; // Cache for local filtering
                applyLocalFiltersAndRender();
            } else {
                resultCount.textContent = 'Failed to load data.';
            }
            
            tableLoader.style.display = 'none';
        }

        // --- FILTERING & RENDERING (LOCAL) ---

        /**
         * Applies local filters (like 'needs greeting' toggle)
         * and sorting, then renders the table.
         */
        function applyLocalFiltersAndRender() {
            let dataToRender = [...currentDataCache];

            // 1. Apply "Needs Greeting" Toggle
            if (needsGreetingToggle.checked) {
                dataToRender = dataToRender.filter(p => !p.isLogged);
            }
            
            // 2. Sort the data
            sortData(dataToRender);
            
            // 3. Render
            renderTable(dataToRender);
        }

        /**
         * Sorts the data based on the currentSort global.
         */
        function sortData(data) {
            data.sort((a, b) => {
                let valA, valB;
                
                if (currentSort.column === 'birthday') {
                    // Sort by month, then day
                    if (a.month !== b.month) {
                        valA = a.month;
                        valB = b.month;
                    } else {
                        valA = a.day;
                        valB = b.day;
                    }
                } else {
                    valA = a[currentSort.column];
                    valB = b[currentSort.column];
                }

                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                
                // Secondary sort: if values are equal, sort by priority
                if (currentSort.column !== 'priority') {
                    return a.priority - b.priority;
                }
                
                return 0;
            });
        }

        /**
         * Renders the data into the HTML table.
         */
        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                resultCount.textContent = 'No officials found matching your criteria.';
                return;
            }

            resultCount.textContent = `Found ${data.length} officials.`;
            const fragment = document.createDocumentFragment();

            data.forEach(person => {
                const tr = document.createElement('tr');
                // Format: MM-DD (YYYY)
                const bdayStr = `${String(person.month).padStart(2, '0')}-${String(person.day).padStart(2, '0')} (${person.year})`;
                
                let priorityHtml;
                if(person.priority <= 3) {
                    priorityHtml = `<span class="priority-badge p-${person.priority}">P${person.priority}</span>`;
                } else {
                    priorityHtml = `N/A`;
                }

                tr.innerHTML = `
                    <td>${priorityHtml}</td>
                    <td>${bdayStr}</td>
                    <td>${person.name}</td>
                    <td>${person.position}</td>
                    <td>${person.barangay}</td>
                    <td>${person.municipality}</td>
                    <td>${person.contact}</td>
                    <td>
                        <button class="action-btn template-btn" data-json='${JSON.stringify(person)}'>Template</button>
                        <button class="action-btn log-btn ${person.isLogged ? 'logged' : ''}" 
                                data-name="${person.name}" 
                                data-pos="${person.position}" 
                                data-mun="${person.municipality}"
                                ${person.isLogged ? 'disabled' : ''}>
                            ${person.isLogged ? 'Logged' : 'Log'}
                        </button>
                        <button class="action-btn copy-btn" data-contact="${person.contact}">Copy</button>
                    </td>
                `;
                fragment.appendChild(tr);
            });

            tableBody.appendChild(fragment);
        }
        
        /**
         * Helper to populate select dropdowns.
         */
        function populateSelect(selectElement, items, defaultOptionText) {
            selectElement.innerHTML = ''; // Clear existing
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = defaultOptionText;
            selectElement.appendChild(defaultOption);
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeDateFilter = btn.dataset.filter;
                    
                    // Disable/Enable month filter
                    monthFilter.disabled = (activeDateFilter !== 'all');
                    if(activeDateFilter === 'today') {
                        const today = new Date();
                        monthFilter.value = today.getMonth() + 1;
                    } else if (activeDateFilter === 'all') {
                         monthFilter.value = ""; // Set to "All Months"
                    }
                    
                    loadFilteredData(); // Fetch new data
                });
            });

            // Filters
            // Debounce search input
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadFilteredData();
                }, 300); // Wait 300ms after user stops typing
            });
            
            monthFilter.addEventListener('change', loadFilteredData);
            municipalityFilter.addEventListener('change', loadFilteredData);
            positionFilter.addEventListener('change', loadFilteredData);
            barangayFilter.addEventListener('change', loadFilteredData);
            
            // Local filter (toggle)
            needsGreetingToggle.addEventListener('change', applyLocalFiltersAndRender);
            
            // Table Sorting
            document.querySelectorAll('#birthday-table th').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (!column) return;
                    
                    if (currentSort.column === column) {
                        currentSort.asc = !currentSort.asc;
                    } else {
                        currentSort.column = column;
                        currentSort.asc = true;
                    }
                    applyLocalFiltersAndRender();
                });
            });
            
            // Table Action Buttons (Event Delegation)
            tableBody.addEventListener('click', e => {
                const target = e.target.closest('.action-btn');
                if (!target) return; // Clicked inside td, not on a button
                
                // Log Greeting
                if (target.classList.contains('log-btn') && !target.disabled) {
                    handleLogGreeting(target);
                }
                // Copy Contact
                if (target.classList.contains('copy-btn')) {
                    handleCopyContact(target);
                }
                // Open Template
                if (target.classList.contains('template-btn')) {
                    // Escape single quotes for JSON
                    const personJson = target.dataset.json.replace(/'/g, "\\'");
                    const person = JSON.parse(personJson);
                    handleOpenTemplateModal(person);
                }
            });

            // Add Person Modal
            openAddModalBtn.addEventListener('click', () => addModal.style.display = 'flex');
            closeAddModalBtn.addEventListener('click', () => addModal.style.display = 'none');
            cancelFormBtn.addEventListener('click', () => addModal.style.display = 'none');
            addPersonForm.addEventListener('submit', handleAddPerson);

            // Template Modal
            closeTemplateModalBtn.addEventListener('click', () => templateModal.style.display = 'none');
            // Copy buttons inside template modal (delegation)
            templateListBody.addEventListener('click', e => {
                if (e.target.classList.contains('template-copy-btn')) {
                    const text = e.target.dataset.text;
                    navigator.clipboard.writeText(text).then(() => {
                        e.target.textContent = 'Copied!';
                        setTimeout(() => { e.target.textContent = 'Copy Text'; }, 2000);
                    });
                }
            });

            // Close modals on outside click
            window.addEventListener('click', e => {
                if (e.target == addModal) addModal.style.display = 'none';
                if (e.target == templateModal) templateModal.style.display = 'none';
            });
        }
        
        // --- ACTION HANDLERS ---

        /**
         * Handles the "Add Person" form submission.
         */
        async function handleAddPerson(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const payload = {
                fullName: document.getElementById('form-fullName').value,
                birthday: document.getElementById('form-birthday').value, // YYYY-MM-DD
                contactNo: document.getElementById('form-contactNo').value,
                position: document.getElementById('form-position').value,
                barangay: document.getElementById('form-barangay').value,
                municipality: document.getElementById('form-municipality').value,
            };

            try {
                const result = await fetchFromScript('addOfficial', payload);
                showFormStatus('Success! Official added.', 'success');
                
                // Refresh dashboard and filters (in background)
                loadDashboardData();
                loadFilterOptions(); // In case of new position/brgy
                
                // Refresh current table view
                loadFilteredData(); 
                
                setTimeout(() => {
                    addModal.style.display = 'none';
                    addPersonForm.reset();
                    formStatus.style.display = 'none';
                }, 2000);
            } catch (error) {
                showFormStatus(`Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Official';
            }
        }
        
        /**
         * Logs a greeting by sending data to the script and updating the UI.
         */
        async function handleLogGreeting(button) {
            button.disabled = true;
            button.textContent = '...';
            
            const payload = {
                fullName: button.dataset.name,
                position: button.dataset.pos,
                municipality: button.dataset.mun,
            };

            try {
                await fetchFromScript('logGreeting', payload);
                
                button.textContent = 'Logged';
                button.classList.add('logged');
                
                // Update in-memory data
                const person = currentDataCache.find(p => p.name === payload.fullName);
                if (person) {
                    person.isLogged = true;
                }
                
                // Re-apply local filters (e.g., if 'needs greeting' is on)
                applyLocalFiltersAndRender();
                
                // Refresh dashboard count
                loadDashboardData();

            } catch (error) {
                button.disabled = false;
                button.textContent = 'Log';
                alert(`Could not log greeting: ${error.message}`);
            }
        }
        
        /**
         * Copies contact number to clipboard.
         */
        function handleCopyContact(button) {
            const contact = button.dataset.contact;
            if (contact && contact !== 'N/A' && contact !== 'nan') {
                navigator.clipboard.writeText(contact).then(() => {
                    button.textContent = 'Copied!';
                    setTimeout(() => { button.textContent = 'Copy'; }, 2000);
                }).catch(err => console.error('Failed to copy text: ', err));
            } else {
                button.textContent = 'No #';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            }
        }
        
        /**
         * Opens the greeting template modal and populates it.
         */
        function handleOpenTemplateModal(person) {
            templateModalName.textContent = person.name;
            
            // Get just the last name
            const nameParts = person.name.split(' ');
            const lastName = nameParts[nameParts.length - 1];
            
            // Create templates
            const templates = [
                {
                    title: "Formal (Tagalog)",
                    text: `Magandang araw, ${person.position} ${lastName}!\n\nIsang maligayang bati sa Iyong kaarawan! Nawa'y pagpalain ka pa ng mabuting kalusugan at tagumpay. Pagbati mula sa aming tanggapan!`
                },
                {
                    title: "Informal (Tagalog)",
                    text: `Happy Birthday, ${person.position} ${lastName}! Wishing you all the best on your special day. God bless po!`
                },
                {
                    title: "Short & Simple (Text)",
                    text: `Happy Birthday po ${person.position} ${lastName}! Pagbati mula sa aming opisina.`
                }
            ];

            templateListBody.innerHTML = ''; // Clear old ones
            templates.forEach(template => {
                const div = document.createElement('div');
                div.className = 'template';
                div.innerHTML = `
                    <div class="template-body" style="white-space: pre-wrap;">${template.text}</div>
                    <div class="template-actions">
                        <button class="template-copy-btn" data-text="${template.text}">Copy Text</button>
                    </div>
                `;
                templateListBody.appendChild(div);
            });
            
            templateModal.style.display = 'flex';
        }

        /**
         * Shows a status message on the modal form.
         */
        function showFormStatus(message, type) {
            formStatus.textContent = message;
            formStatus.className = `status-message ${type}`;
            formStatus.style.display = 'block';
        }
    </script>

</body>
</html>


